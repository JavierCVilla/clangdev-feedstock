From ab712ffd22167d60b6b80e2f15599904e114469b Mon Sep 17 00:00:00 2001
From: Axel Naumann <Axel.Naumann@cern.ch>
Date: Tue, 17 Mar 2015 14:55:07 +0100
Subject: [PATCH 34/62] Provide (possibly updated) CodegenOpts to StartModule.

---
 include/clang/CodeGen/ModuleBuilder.h |  1 -
 lib/CodeGen/ModuleBuilder.cpp         | 10 ++++++----
 2 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/include/clang/CodeGen/ModuleBuilder.h b/include/clang/CodeGen/ModuleBuilder.h
index 9b24d36439..207ae582f1 100644
--- a/include/clang/CodeGen/ModuleBuilder.h
+++ b/include/clang/CodeGen/ModuleBuilder.h
@@ -89,7 +89,6 @@ public:
 
   void print(llvm::raw_ostream& out);
   void forgetGlobal(llvm::GlobalValue* GV);
-  void forgetDecl(const GlobalDecl& GD, llvm::StringRef MangledName);
   llvm::Module* StartModule(llvm::StringRef ModuleName,
                             llvm::LLVMContext& C,
                             const CodeGenOptions& CGO);
diff --git a/lib/CodeGen/ModuleBuilder.cpp b/lib/CodeGen/ModuleBuilder.cpp
index 6053b85434..7eefef7168 100644
--- a/lib/CodeGen/ModuleBuilder.cpp
+++ b/lib/CodeGen/ModuleBuilder.cpp
@@ -35,7 +35,7 @@ namespace clang {
     ASTContext *Ctx;
     const HeaderSearchOptions &HeaderSearchOpts; // Only used for debug info.
     const PreprocessorOptions &PreprocessorOpts; // Only used for debug info.
-    const CodeGenOptions CodeGenOpts;  // Intentionally copied in.
+    CodeGenOptions CodeGenOpts;  // Intentionally copied in.
 
     unsigned HandlingTopLevelDecls;
 
@@ -126,6 +126,7 @@ namespace clang {
 
       std::unique_ptr<CodeGen::CodeGenModule> OldBuilder;
       OldBuilder.swap(Builder);
+      CodeGenOpts = CGO;
       M.reset(new llvm::Module(ModuleName, C));
       Initialize(*Ctx);
 
@@ -484,9 +485,10 @@ void CodeGenerator::forgetGlobal(llvm::GlobalValue* GV) {
 }
 
 
-llvm::Module *CodeGenerator::StartModule(const std::string& ModuleName,
-                                         llvm::LLVMContext& C) {
-   return static_cast<CodeGeneratorImpl*>(this)->StartModule(ModuleName, C);
+llvm::Module *CodeGenerator::StartModule(llvm::StringRef ModuleName,
+                                         llvm::LLVMContext& C,
+                                         const CodeGenOptions& CGO) {
+  return static_cast<CodeGeneratorImpl*>(this)->StartModule(ModuleName, C, CGO);
 }
 
 CodeGenerator *clang::CreateLLVMCodeGen(
-- 
2.18.0

