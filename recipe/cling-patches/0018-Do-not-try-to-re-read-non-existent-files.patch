From 0fc4dd156c05cd2e57a445d64a9031cfce124d16 Mon Sep 17 00:00:00 2001
From: Axel Naumann <Axel.Naumann@cern.ch>
Date: Tue, 15 Apr 2014 12:12:19 +0200
Subject: [PATCH 18/62] Do not try to re-read non-existent files.

---
 lib/Basic/FileManager.cpp | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/Basic/FileManager.cpp b/lib/Basic/FileManager.cpp
index 3ff179e67b..4307222802 100644
--- a/lib/Basic/FileManager.cpp
+++ b/lib/Basic/FileManager.cpp
@@ -222,7 +222,7 @@ const FileEntry *FileManager::getFile(StringRef Filename, bool openFile,
 
   const FileEntry *StaleFileEntry = 0;
   bool needsRereading = false;
-  if (NamedFileEnt.getValue()) {
+  if (NamedFileEnt.getValue() && NamedFileEnt.getValue() != NON_EXISTENT_FILE) {
     std::set<const FileEntry*>::const_iterator found
       = FileEntriesToReread.find(NamedFileEnt.getValue());
     if (found != FileEntriesToReread.end()) {
@@ -513,6 +513,7 @@ bool FileManager::getNoncachedStatValue(StringRef Path,
 
 void FileManager::invalidateCache(FileEntry *Entry) {
   assert(Entry && "Cannot invalidate a NULL FileEntry");
+  assert(Entry != NON_EXISTENT_FILE && "Cannot invalidate a missing FileEntry");
   FileEntriesToReread.insert(Entry);
   Entry->IsValid = false;
 }
-- 
2.18.0

