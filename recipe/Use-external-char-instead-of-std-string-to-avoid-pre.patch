From b801fb8f7d6dd0eceda7ae34c0d8c02144ddf948 Mon Sep 17 00:00:00 2001
From: Christopher Burr <christopher.burr@cern.ch>
Date: Thu, 24 Jan 2019 10:48:09 +0000
Subject: [PATCH] Use external char* instead of std::string to avoid prefix
 replacement errors

---
 lib/Driver/CMakeLists.txt | 1 +
 lib/Driver/ToolChains/Linux.cpp   | 7 ++++++-
 lib/Driver/ToolChains/Linux_sysroot.cc | 7 +++++++
 3 files changed, 14 insertions(+), 1 deletion(-)
 create mode 100644 lib/Driver/ToolChains/Linux_sysroot.cc

diff --git a/lib/Driver/CMakeLists.txt b/lib/Driver/CMakeLists.txt
index c7ca698d95..0b73889608 100644
--- a/lib/Driver/CMakeLists.txt
+++ b/lib/Driver/CMakeLists.txt
@@ -46,6 +46,7 @@ add_clang_library(clangDriver
   ToolChains/Gnu.cpp
   ToolChains/Haiku.cpp
   ToolChains/Hexagon.cpp
+  ToolChains/Linux_sysroot.cc
   ToolChains/Linux.cpp
   ToolChains/MipsLinux.cpp
   ToolChains/MinGW.cpp
diff --git a/lib/Driver/ToolChains/Linux.cpp b/lib/Driver/ToolChains/Linux.cpp
index 992b22eac1..1de7c6912f 100644
--- a/lib/Driver/ToolChains/Linux.cpp
+++ b/lib/Driver/ToolChains/Linux.cpp
@@ -380,6 +380,11 @@ Tool *Linux::buildAssembler() const {
   return new tools::gnutools::Assembler(*this);
 }

+extern "C"
+{
+  const char *conda_sysroot_directory();
+}
+
 std::string Linux::computeSysRoot() const {
   if (char *env = ::getenv("CONDA_BUILD_SYSROOT")) {
     // We only use this value as the default if it is an absolute path and exists
@@ -388,7 +393,7 @@ std::string Linux::computeSysRoot() const {
     }
   }

-  return "SYSROOT_PATH_TO_BE_REPLACED_WITH_SED";
+  return conda_sysroot_directory();
 }

 std::string Linux::getDynamicLinker(const ArgList &Args) const {
diff --git a/lib/Driver/ToolChains/Linux_sysroot.cc b/lib/Driver/ToolChains/Linux_sysroot.cc
new file mode 100644
index 0000000000..0f5995f74f
--- /dev/null
+++ b/lib/Driver/ToolChains/Linux_sysroot.cc
@@ -0,0 +1,7 @@
+extern "C"
+{
+  const char *conda_sysroot_directory()
+  {
+    return "SYSROOT_PATH_TO_BE_REPLACED_WITH_SED";
+  }
+}
--
2.20.0

